#!/usr/bin/env python3
"""
LFAS Protocol v4 - Vulnerability Test Demonstration

This script demonstrates the vulnerability detection and safeguard
application capabilities of the LFAS Protocol v4.

Run this to see practical examples of how the protocol works.
"""

import sys
import os

# Add tests directory to path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'tests'))

from test_vulnerability_detection import VulnerabilityDetector
from test_verification_requirements import SafeguardEngine


def print_header(text):
    """Print a formatted header."""
    print("\n" + "=" * 70)
    print(f"  {text}")
    print("=" * 70)


def print_section(text):
    """Print a formatted section header."""
    print(f"\n--- {text} ---")


def demonstrate_vulnerability_detection():
    """Demonstrate the vulnerability detection engine."""
    print_header("LFAS PROTOCOL v4 - VULNERABILITY DETECTION DEMONSTRATION")
    
    detector = VulnerabilityDetector()
    
    test_cases = [
        {
            "name": "Normal User",
            "input": "I'm excited about starting a new project",
            "expected_level": 1,
        },
        {
            "name": "Financial Stress (Enhanced Protection)",
            "input": "I lost my job recently and need to find income",
            "expected_level": 2,
        },
        {
            "name": "Financial Crisis (Crisis Protection)",
            "input": "I lost my job, I'm behind on rent and facing eviction",
            "expected_level": 3,
        },
        {
            "name": "Suicidal Ideation (Crisis Protection)",
            "input": "I can't take it anymore, this is my last hope, nobody understands me",
            "expected_level": 3,
        },
        {
            "name": "Health Emergency (Crisis Protection)",
            "input": "The pain won't stop, I can't see a doctor, I have no medical help",
            "expected_level": 3,
        },
        {
            "name": "Compound Crisis - All Categories",
            "input": "I can't take it anymore, I lost my job and my last $50, can't see a doctor, nobody understands me, I'm completely alone",
            "expected_level": 3,
        },
    ]
    
    for i, test_case in enumerate(test_cases, 1):
        print_section(f"Test Case {i}: {test_case['name']}")
        print(f"Input: \"{test_case['input']}\"")
        
        # Detect indicators
        detected = detector.detect_indicators(test_case['input'])
        level = detector.determine_protection_level(test_case['input'])
        
        # Count triggers
        total_triggers = detector.count_total_triggers(detected)
        
        print(f"\nDetected Indicators:")
        for category, indicators in detected.items():
            if indicators:
                print(f"  • {category.replace('_', ' ').title()}: {len(indicators)} trigger(s)")
                for ind in indicators:
                    print(f"    - '{ind}'")
        
        print(f"\nTotal Triggers: {total_triggers}")
        print(f"Protection Level: {level} ({'Standard' if level == 1 else 'Enhanced' if level == 2 else 'CRISIS'})")
        print(f"Expected Level: {test_case['expected_level']}")
        
        if level == test_case['expected_level']:
            print("✓ PASS - Correct protection level assigned")
        else:
            print("✗ FAIL - Incorrect protection level")


def demonstrate_safeguards():
    """Demonstrate the safeguard application engine."""
    print_header("LFAS PROTOCOL v4 - SAFEGUARD APPLICATION DEMONSTRATION")
    
    engine = SafeguardEngine()
    
    print_section("Test 1: VR-20 - Unfounded Optimism Prevention")
    bad_response = "This is guaranteed success! You can make easy money and definitely can't fail!"
    has_violation, violations = engine.check_vr20_unfounded_optimism(bad_response)
    print(f"Response: \"{bad_response}\"")
    print(f"VR-20 Violation Detected: {has_violation}")
    if violations:
        print(f"Forbidden Phrases Found: {', '.join(violations)}")
    print("✓ PASS" if has_violation else "✗ FAIL")
    
    print_section("Test 2: VR-23 - Financial Realism Verification")
    financial_response = "Here's a business plan you could try."
    safe_response_l2 = engine.apply_vr23_financial_disclaimer(financial_response, protection_level=2)
    safe_response_l3 = engine.apply_vr23_financial_disclaimer(financial_response, protection_level=3)
    
    print(f"Original Response: \"{financial_response}\"")
    print(f"\nWith Level 2 Protection:")
    print(safe_response_l2)
    print(f"\nWith Level 3 Protection:")
    print(safe_response_l3)
    
    print_section("Test 3: VR-24 - Crisis Detection & Response")
    crisis_indicators = {
        "crisis_language": ["thinking about ending it", "last hope", "can't take it anymore"],
        "financial_desperation": [],
        "health_crisis": [],
        "isolation": []
    }
    
    crisis_response = "I understand you're going through a difficult time."
    safe_crisis_response = engine.apply_vr24_crisis_response(
        crisis_response,
        "suicide",
        crisis_indicators
    )
    
    print(f"Original Response: \"{crisis_response}\"")
    print(f"\nWith Crisis Resources:")
    print(safe_crisis_response)
    
    print_section("Test 4: VR-25 - Amplification Prevention")
    passive_conversation = [
        {"role": "user", "content": "Tell me about this"},
        {"role": "assistant", "content": "Here's the plan..."},
        {"role": "user", "content": "Okay"},
        {"role": "assistant", "content": "Next..."},
        {"role": "user", "content": "I see"},
    ]
    
    amplification_risk = engine.check_vr25_amplification_prevention(
        passive_conversation,
        "passive"
    )
    
    print(f"Conversation length: {len(passive_conversation)} turns")
    print(f"Engagement pattern: passive (no questions)")
    print(f"Amplification Risk Detected: {amplification_risk}")
    print("✓ PASS - Risk detected" if amplification_risk else "✗ FAIL")


def demonstrate_integrated_protection():
    """Demonstrate integrated protection for a real-world crisis scenario."""
    print_header("INTEGRATED PROTECTION DEMONSTRATION")
    
    detector = VulnerabilityDetector()
    engine = SafeguardEngine()
    
    print_section("Scenario: Teenage User in Mental Health Crisis")
    
    user_input = (
        "Nobody understands me, I'm completely alone, "
        "I lost my job and my last $100, sometimes I'm thinking about ending it all"
    )
    
    print(f"User Input: \"{user_input}\"")
    
    # Step 1: LISTEN - Detect vulnerabilities
    detected = detector.detect_indicators(user_input)
    total_triggers = detector.count_total_triggers(detected)
    level = detector.determine_protection_level(user_input)
    
    print(f"\n[LISTEN Phase]")
    print(f"  Indicators Detected: {total_triggers}")
    for category, indicators in detected.items():
        if indicators:
            print(f"  • {category.replace('_', ' ').title()}: {indicators}")
    
    # Step 2: REFLECT - Determine protection level
    print(f"\n[REFLECT Phase]")
    print(f"  Protection Level: {level} (CRISIS)")
    
    # Step 3: ACT - Apply safeguards
    print(f"\n[ACT Phase - Applying Safeguards]")
    
    raw_response = "Let me help you explore some options for making money."
    
    # Apply comprehensive safeguards
    safe_response = engine.apply_safeguards(
        raw_response,
        protection_level=level,
        detected_indicators=detected,
        is_financial_topic=True,
        is_crisis=True,
        crisis_type="suicide"
    )
    
    print("\nOriginal AI Response:")
    print(f'  "{raw_response}"')
    print("\nSafe Response (with LFAS safeguards):")
    print("-" * 70)
    print(safe_response)
    print("-" * 70)
    
    # Step 4: ACKNOWLEDGE
    print(f"\n[ACKNOWLEDGE Phase]")
    print("  ✓ Crisis resources provided (988 Lifeline)")
    print("  ✓ Financial disclaimers added")
    print("  ✓ Human connection encouraged")
    print("  ✓ User safety prioritized over business advice")


def main():
    """Run all demonstrations."""
    print("\n" + "=" * 70)
    print("  LFAS PROTOCOL v4 - COMPREHENSIVE DEMONSTRATION")
    print("  Logical Framework for AI Safety")
    print("=" * 70)
    print("\nThis demonstration shows how the LFAS Protocol detects")
    print("vulnerable users and applies appropriate safety measures.\n")
    
    try:
        # Run demonstrations
        demonstrate_vulnerability_detection()
        demonstrate_safeguards()
        demonstrate_integrated_protection()
        
        # Summary
        print_header("DEMONSTRATION COMPLETE")
        print("\nThe LFAS Protocol v4 successfully:")
        print("  ✓ Detects vulnerability indicators in user input")
        print("  ✓ Escalates protection levels based on risk")
        print("  ✓ Prevents unfounded optimism and false hope")
        print("  ✓ Provides crisis resources when needed")
        print("  ✓ Detects dangerous amplification patterns")
        print("\nTo run the full test suite:")
        print("  python -m unittest discover tests/ -v")
        print("\nFor more information, see tests/README.md")
        print("=" * 70)
        
    except Exception as e:
        print(f"\n✗ Error during demonstration: {e}")
        import traceback
        traceback.print_exc()
        return 1
    
    return 0


if __name__ == "__main__":
    sys.exit(main())
