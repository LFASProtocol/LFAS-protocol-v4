"""
Test Suite for LFAS Protocol v4 - Vulnerability Detection Engine

This module tests the vulnerability detection capabilities of the LFAS protocol,
ensuring accurate identification of crisis language, financial desperation,
health emergencies, and isolation indicators.

Test Categories:
1. Crisis Language Detection
2. Financial Desperation Detection
3. Health Crisis Detection
4. Isolation Indicators Detection
5. Protection Level Escalation
"""

import unittest
from typing import List, Dict


class VulnerabilityDetector:
    """
    Vulnerability detection engine based on LFAS Protocol v4 specification.
    
    This class implements the LISTEN phase of the LFAS protocol,
    detecting vulnerability indicators from user input.
    """
    
    def __init__(self):
        """Initialize the vulnerability detection engine with protocol indicators."""
        self.crisis_language_indicators = [
            "last hope",
            "only chance",
            "can't take it anymore",
            "nobody understands",
            "completely alone",
            "if this doesn't work, i'm done",
            "thinking about ending it",
            "don't want to live",
            "want to die",
            "suicide",
            "kill myself",
        ]
        
        self.financial_desperation_indicators = [
            "lost my job",
            "last $",
            "need money fast",
            "desperate for income",
            "can't pay bills",
            "behind on rent",
            "facing eviction",
            "no income",
            "bankruptcy",
        ]
        
        self.health_crisis_indicators = [
            "can't see a doctor",
            "no insurance",
            "pain won't stop",
            "no medical help",
            "afford medication",
            "untreated condition",
            "medical emergency",
        ]
        
        self.isolation_indicators = [
            "no one to talk to",
            "family doesn't understand",
            "you're the only one who listens",
            "completely alone",
            "no friends",
            "nobody cares",
            "nobody understands",
        ]
    
    def detect_indicators(self, user_input: str) -> Dict[str, List[str]]:
        """
        Detect vulnerability indicators in user input.
        
        Args:
            user_input: The user's message to analyze
            
        Returns:
            Dictionary with detected indicator categories and matched phrases
        """
        user_input_lower = user_input.lower()
        detected = {
            "crisis_language": [],
            "financial_desperation": [],
            "health_crisis": [],
            "isolation": []
        }
        
        for indicator in self.crisis_language_indicators:
            if indicator in user_input_lower:
                detected["crisis_language"].append(indicator)
        
        for indicator in self.financial_desperation_indicators:
            if indicator in user_input_lower:
                detected["financial_desperation"].append(indicator)
        
        for indicator in self.health_crisis_indicators:
            if indicator in user_input_lower:
                detected["health_crisis"].append(indicator)
        
        for indicator in self.isolation_indicators:
            if indicator in user_input_lower:
                detected["isolation"].append(indicator)
        
        return detected
    
    def count_total_triggers(self, detected_indicators: Dict[str, List[str]]) -> int:
        """
        Count total number of triggered indicators.
        
        Args:
            detected_indicators: Dictionary of detected indicators by category
            
        Returns:
            Total count of all detected indicators
        """
        return sum(len(indicators) for indicators in detected_indicators.values())
    
    def determine_protection_level(self, user_input: str) -> int:
        """
        Determine the protection level based on detected vulnerability indicators.
        
        Protection Levels (LFAS Protocol v4):
        - Level 1 (Standard): 0 triggers detected
        - Level 2 (Enhanced): 1-2 triggers detected
        - Level 3 (Crisis): 3+ triggers detected
        
        Args:
            user_input: The user's message to analyze
            
        Returns:
            Protection level (1, 2, or 3)
        """
        detected = self.detect_indicators(user_input)
        trigger_count = self.count_total_triggers(detected)
        
        if trigger_count == 0:
            return 1  # Standard Protection
        elif trigger_count <= 2:
            return 2  # Enhanced Protection
        else:
            return 3  # Crisis Protection


class TestCrisisLanguageDetection(unittest.TestCase):
    """
    Test suite for crisis language detection.
    
    Validates that the system correctly identifies suicidal ideation,
    despair, and other crisis-indicating language patterns.
    """
    
    def setUp(self):
        """Initialize the vulnerability detector for each test."""
        self.detector = VulnerabilityDetector()
    
    def test_suicidal_ideation_detection(self):
        """
        Scenario: User expresses suicidal thoughts
        Expected: Crisis language indicator detected
        """
        user_input = "I'm thinking about ending it all"
        detected = self.detector.detect_indicators(user_input)
        
        self.assertGreater(
            len(detected["crisis_language"]), 
            0,
            "Failed to detect suicidal ideation language"
        )
        self.assertIn("thinking about ending it", detected["crisis_language"])
    
    def test_hopelessness_detection(self):
        """
        Scenario: User expresses hopelessness and despair
        Expected: Crisis language indicator detected
        """
        user_input = "This is my last hope, if this doesn't work I'm done"
        detected = self.detector.detect_indicators(user_input)
        
        self.assertGreater(
            len(detected["crisis_language"]),
            0,
            "Failed to detect hopelessness language"
        )
    
    def test_isolation_crisis_language(self):
        """
        Scenario: User expresses extreme isolation
        Expected: Crisis language indicator detected
        """
        user_input = "I can't take it anymore, nobody understands me"
        detected = self.detector.detect_indicators(user_input)
        
        self.assertGreater(
            len(detected["crisis_language"]),
            0,
            "Failed to detect isolation crisis language"
        )
    
    def test_no_crisis_language_in_normal_text(self):
        """
        Scenario: User has normal, non-crisis conversation
        Expected: No crisis language indicators detected
        """
        user_input = "I'm working on a new project and feeling excited about it"
        detected = self.detector.detect_indicators(user_input)
        
        self.assertEqual(
            len(detected["crisis_language"]),
            0,
            "False positive: detected crisis language in normal text"
        )


class TestFinancialDesperationDetection(unittest.TestCase):
    """
    Test suite for financial desperation detection.
    
    Validates detection of financial crisis indicators that may lead
    to vulnerable decision-making.
    """
    
    def setUp(self):
        """Initialize the vulnerability detector for each test."""
        self.detector = VulnerabilityDetector()
    
    def test_job_loss_and_financial_crisis(self):
        """
        Scenario: User has lost job and is in financial distress
        Expected: Financial desperation indicator detected
        """
        user_input = "I lost my job and have my last $100, need money fast"
        detected = self.detector.detect_indicators(user_input)
        
        self.assertGreater(
            len(detected["financial_desperation"]),
            0,
            "Failed to detect financial crisis"
        )
    
    def test_eviction_threat(self):
        """
        Scenario: User facing eviction
        Expected: Financial desperation indicator detected
        """
        user_input = "I'm behind on rent and facing eviction next week"
        detected = self.detector.detect_indicators(user_input)
        
        self.assertGreater(
            len(detected["financial_desperation"]),
            0,
            "Failed to detect eviction crisis"
        )
    
    def test_desperate_income_need(self):
        """
        Scenario: User expressing desperate need for income
        Expected: Financial desperation indicator detected
        """
        user_input = "I'm desperate for income, can't pay my bills"
        detected = self.detector.detect_indicators(user_input)
        
        self.assertGreater(
            len(detected["financial_desperation"]),
            0,
            "Failed to detect desperate income need"
        )
    
    def test_normal_financial_discussion(self):
        """
        Scenario: User discussing finances normally
        Expected: No financial desperation indicators
        """
        user_input = "I'm planning my budget for next month"
        detected = self.detector.detect_indicators(user_input)
        
        self.assertEqual(
            len(detected["financial_desperation"]),
            0,
            "False positive: detected financial desperation in normal discussion"
        )


class TestHealthCrisisDetection(unittest.TestCase):
    """
    Test suite for health crisis detection.
    
    Validates detection of medical emergency and health access issues
    that indicate user vulnerability.
    """
    
    def setUp(self):
        """Initialize the vulnerability detector for each test."""
        self.detector = VulnerabilityDetector()
    
    def test_no_medical_access(self):
        """
        Scenario: User cannot access medical care
        Expected: Health crisis indicator detected
        """
        user_input = "I can't see a doctor, I have no insurance"
        detected = self.detector.detect_indicators(user_input)
        
        self.assertGreater(
            len(detected["health_crisis"]),
            0,
            "Failed to detect lack of medical access"
        )
    
    def test_medication_affordability(self):
        """
        Scenario: User cannot afford needed medication
        Expected: Health crisis indicator detected
        """
        user_input = "I can't afford medication anymore"
        detected = self.detector.detect_indicators(user_input)
        
        self.assertGreater(
            len(detected["health_crisis"]),
            0,
            "Failed to detect medication affordability crisis"
        )
    
    def test_untreated_pain(self):
        """
        Scenario: User experiencing untreated medical pain
        Expected: Health crisis indicator detected
        """
        user_input = "The pain won't stop and I have no medical help"
        detected = self.detector.detect_indicators(user_input)
        
        self.assertGreater(
            len(detected["health_crisis"]),
            0,
            "Failed to detect untreated pain crisis"
        )


class TestIsolationDetection(unittest.TestCase):
    """
    Test suite for isolation indicator detection.
    
    Validates detection of social isolation that may indicate
    vulnerability and amplification risk.
    """
    
    def setUp(self):
        """Initialize the vulnerability detector for each test."""
        self.detector = VulnerabilityDetector()
    
    def test_complete_isolation(self):
        """
        Scenario: User reports complete social isolation
        Expected: Isolation indicator detected
        """
        user_input = "I have no one to talk to, you're the only one who listens"
        detected = self.detector.detect_indicators(user_input)
        
        self.assertGreater(
            len(detected["isolation"]),
            0,
            "Failed to detect complete isolation"
        )
    
    def test_family_disconnect(self):
        """
        Scenario: User feels disconnected from family
        Expected: Isolation indicator detected
        """
        user_input = "My family doesn't understand me at all"
        detected = self.detector.detect_indicators(user_input)
        
        self.assertGreater(
            len(detected["isolation"]),
            0,
            "Failed to detect family disconnect"
        )
    
    def test_perceived_abandonment(self):
        """
        Scenario: User feels abandoned
        Expected: Isolation indicator detected
        """
        user_input = "Nobody cares about what happens to me"
        detected = self.detector.detect_indicators(user_input)
        
        self.assertGreater(
            len(detected["isolation"]),
            0,
            "Failed to detect perceived abandonment"
        )


class TestProtectionLevelEscalation(unittest.TestCase):
    """
    Test suite for protection level escalation logic.
    
    Validates that the system correctly escalates protection levels
    based on the number and severity of detected vulnerability indicators.
    
    Protection Levels:
    - Level 1 (Standard): 0 triggers
    - Level 2 (Enhanced): 1-2 triggers  
    - Level 3 (Crisis): 3+ triggers
    """
    
    def setUp(self):
        """Initialize the vulnerability detector for each test."""
        self.detector = VulnerabilityDetector()
    
    def test_standard_protection_level(self):
        """
        Scenario: No vulnerability indicators present
        Expected: Protection Level 1 (Standard)
        """
        user_input = "I'm excited about starting a new project"
        level = self.detector.determine_protection_level(user_input)
        
        self.assertEqual(
            level,
            1,
            "Failed to assign Standard Protection (Level 1) for safe input"
        )
    
    def test_enhanced_protection_single_trigger(self):
        """
        Scenario: Single vulnerability indicator detected
        Expected: Protection Level 2 (Enhanced)
        """
        user_input = "I lost my job recently"
        level = self.detector.determine_protection_level(user_input)
        
        self.assertEqual(
            level,
            2,
            "Failed to escalate to Enhanced Protection (Level 2) for single trigger"
        )
    
    def test_enhanced_protection_two_triggers(self):
        """
        Scenario: Two vulnerability indicators detected
        Expected: Protection Level 2 (Enhanced)
        """
        user_input = "I lost my job and can't pay my bills"
        level = self.detector.determine_protection_level(user_input)
        
        self.assertEqual(
            level,
            2,
            "Failed to maintain Enhanced Protection (Level 2) for two triggers"
        )
    
    def test_crisis_protection_three_triggers(self):
        """
        Scenario: Three vulnerability indicators detected
        Expected: Protection Level 3 (Crisis)
        """
        user_input = "I lost my job, can't pay bills, and this is my last hope"
        level = self.detector.determine_protection_level(user_input)
        
        self.assertEqual(
            level,
            3,
            "Failed to escalate to Crisis Protection (Level 3) for three triggers"
        )
    
    def test_crisis_protection_multiple_categories(self):
        """
        Scenario: Multiple indicators across different categories
        Expected: Protection Level 3 (Crisis)
        """
        user_input = "I can't take it anymore, lost my job, nobody understands, and I'm completely alone"
        level = self.detector.determine_protection_level(user_input)
        
        self.assertEqual(
            level,
            3,
            "Failed to escalate to Crisis Protection for multiple category triggers"
        )
    
    def test_severe_crisis_many_triggers(self):
        """
        Scenario: Severe crisis with many indicators
        Expected: Protection Level 3 (Crisis)
        """
        user_input = (
            "This is my last hope, I lost my job, have no money, "
            "can't see a doctor, nobody cares, I'm completely alone, "
            "and I can't take it anymore"
        )
        level = self.detector.determine_protection_level(user_input)
        
        self.assertEqual(
            level,
            3,
            "Failed to recognize severe crisis situation"
        )


class TestComplexScenarios(unittest.TestCase):
    """
    Test suite for complex, real-world vulnerability scenarios.
    
    These tests validate the system's ability to handle nuanced
    and realistic user interactions that may combine multiple
    vulnerability indicators.
    """
    
    def setUp(self):
        """Initialize the vulnerability detector for each test."""
        self.detector = VulnerabilityDetector()
    
    def test_financial_crisis_with_family_pressure(self):
        """
        Scenario: User facing financial crisis with family pressure
        Expected: Multiple indicators detected, Crisis Protection (Level 3)
        
        Real-world context: This represents a common vulnerability pattern
        where financial stress compounds with social isolation.
        """
        user_input = (
            "I need money fast, I'm behind on rent, my family doesn't understand, "
            "and if this business idea doesn't work, I'm done"
        )
        
        detected = self.detector.detect_indicators(user_input)
        level = self.detector.determine_protection_level(user_input)
        
        # Should detect financial and isolation indicators
        self.assertGreater(len(detected["financial_desperation"]), 0)
        self.assertGreater(len(detected["isolation"]), 0)
        
        # Should escalate to Crisis Protection
        self.assertEqual(level, 3)
    
    def test_health_crisis_without_support(self):
        """
        Scenario: Medical emergency with no support system
        Expected: Multiple indicators, Crisis Protection (Level 3)
        
        Real-world context: Vulnerable users may face health crises
        while socially isolated, requiring maximum protection.
        """
        user_input = (
            "The pain won't stop, I can't afford medication, "
            "I have no one to talk to about this"
        )
        
        detected = self.detector.detect_indicators(user_input)
        level = self.detector.determine_protection_level(user_input)
        
        # Should detect health and isolation indicators
        self.assertGreater(len(detected["health_crisis"]), 0)
        self.assertGreater(len(detected["isolation"]), 0)
        
        # Should escalate to Crisis Protection
        self.assertEqual(level, 3)
    
    def test_mental_health_crisis_all_categories(self):
        """
        Scenario: Severe mental health crisis spanning all categories
        Expected: Maximum indicator detection, Crisis Protection (Level 3)
        
        Real-world context: Represents the most vulnerable user state
        requiring immediate intervention and maximum safeguards.
        """
        user_input = (
            "I can't take it anymore, I lost my job and my last $50, "
            "can't see a doctor for help, nobody understands me, "
            "I'm completely alone, this is my only chance"
        )
        
        detected = self.detector.detect_indicators(user_input)
        level = self.detector.determine_protection_level(user_input)
        
        # Should detect indicators in all categories
        self.assertGreater(len(detected["crisis_language"]), 0)
        self.assertGreater(len(detected["financial_desperation"]), 0)
        self.assertGreater(len(detected["health_crisis"]), 0)
        self.assertGreater(len(detected["isolation"]), 0)
        
        # Should be at maximum Crisis Protection
        self.assertEqual(level, 3)
    
    def test_elderly_user_scam_vulnerability(self):
        """
        Scenario: Elderly user vulnerable to financial scams
        Expected: Financial desperation indicators, Enhanced/Crisis Protection
        
        Real-world context: Elderly users may be particularly vulnerable
        to get-rich-quick schemes when facing financial pressure.
        """
        user_input = (
            "I need money fast to pay bills, my last savings are running out, "
            "is this investment opportunity legitimate?"
        )
        
        detected = self.detector.detect_indicators(user_input)
        level = self.detector.determine_protection_level(user_input)
        
        # Should detect financial desperation
        self.assertGreater(len(detected["financial_desperation"]), 0)
        
        # Should be at least Enhanced Protection
        self.assertGreaterEqual(level, 2)
    
    def test_teenager_mental_health_vulnerability(self):
        """
        Scenario: Teenager expressing suicidal ideation
        Expected: Crisis language detection, Crisis Protection (Level 3)
        
        Real-world context: Young users may express crisis thoughts
        that require immediate protective response.
        """
        user_input = (
            "Nobody understands me at school, I feel completely alone, "
            "sometimes I'm thinking about ending it all"
        )
        
        detected = self.detector.detect_indicators(user_input)
        level = self.detector.determine_protection_level(user_input)
        
        # Should detect crisis language and isolation
        self.assertGreater(len(detected["crisis_language"]), 0)
        self.assertGreater(len(detected["isolation"]), 0)
        
        # Should escalate to Crisis Protection
        self.assertEqual(level, 3)


if __name__ == "__main__":
    unittest.main(verbosity=2)
